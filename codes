import random
import time

values = {'Two': 2, 'Three': 3, 'Four': 4, 'Five': 5, 'Six': 6, 'Seven': 7, 'Eight': 8, 'Nine': 9,
          'Ten': 10, 'Jack': 10, 'Queen': 10, 'King': 10, 'Ace': 11}


class Card:
    def __init__(self, rank, suit):
        self.suit = suit
        self.rank = rank

    def __str__(self):
        return self.rank + self.suit


class Deck:
    def __init__(self, deck_number=1):
        self.suits = [' of Heart', ' of Diamond', ' of Spade', ' of Club']
        self.ranks = ['Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten',
                      'Jack', 'Queen', 'King', 'Ace']
        self.deck = []
        for rank in self.ranks:
            for suit in self.suits:
                self.deck.append(Card(rank, suit))
        self.deck = self.deck * deck_number

    def shuffle(self):
        random.shuffle(self.deck)

    def draw_card(self):
        drawn_card = self.deck.pop()
        return drawn_card

    def __str__(self):
        return 'Deck = {}'.format(self.deck)


class Player:
    def __init__(self, player_name, balance=0):
        self.cards = []
        self.value = 0
        self.aces = 0
        self.player_name = player_name
        self.balance = balance
        self.bet = 0

    def store_card(self, card):
        self.cards.append(card)
        self.value += values[card.rank]
        if card.rank == 'Ace':
            self.aces += 1

    def aces(self):
        while self.value > 21 and self.aces:
            self.value -= 10
            self.aces -= 1

    def print_hand(self):
        str1 = ', '.join(self.cards)
        return "{}'s cards: {}".format(self.player_name, str1)

    def win(self):
        self.balance += self.bet

    def lose(self):
        self.balance -= self.bet

    def input_bet(self):
        while True:
            try:
                self.bet = int(input('Place your bet {}:'.format(self.player_name)))
            except ValueError:
                print('ENTER A NUMBER')
            else:
                if self.bet > self.balance:
                    print("Sorry, your bet can't exceed ", self.balance)
                else:
                    break


class Dealer:
    def __init__(self):
        self.cards = []
        self.value = 0
        self.aces = 0

    def store_card(self, card):
        self.cards.append(card)
        self.value += values[card.rank]
        if card.rank == 'Ace':
            self.aces += 1

    def aces(self):
        while self.value > 21 and self.aces:
            self.value -= 10
            self.aces -= 1

    def print_hand(self):
        if len(self.cards) == 2:
            return "Dealer's cards: {}, Hidden".format(self.cards[0])
        else:
            return "Dealer's cards: {}".format(self.cards)


class Main:
    playing = True
    dealer = Dealer()
    player_number = 0
    player_list = []

    print('Welcome to BlackJack, please answer the following questions.')

    # Deck number
    while True:
        try:
            deck_number = int(input('Number of decks to use'))
        except ValueError:
            print('ENTER A NUMBER')
        else:
            if deck_number in range(1, 8):
                break
            else:
                print('Minimum 1 deck, Maximum 7 decks')

    # Player number
    while True:
        try:
            player_number = int(input('Enter the number of players: '))
        except ValueError:
            print('ENTER A NUMBER')
        else:
            if player_number in range(1, 4):
                break
            else:
                print('Minimum 1 player, Maximum 3 players')

    # Creating list of players
    for n in range(0, player_number):
        name = input('Enter the player name: ')
        deposit = int(input('How much money do you have: '))
        player_list.append(Player(name, deposit))

    print('Game about to start in 5')
    time.sleep(1)
    for i in range(4, 0, -1):
        print('{}...'.format(i))
    time.sleep(1)

    # Game Started
    while True:

        deck = Deck(deck_number)
        deck.shuffle()

        # Two card for dealer and each player
        dealer.store_card(deck.draw_card())
        for player in player_list:
            player.store_card(deck.draw_card())
        dealer.store_card(deck.draw_card())
        for player in player_list:
            player.store_card(deck.draw_card())

        dealer.print_hand()
        for player in player_list:
            player.print_hand()

        for player in player_list:
            player.input_bet()

        # Players actions
        while playing:

            for player in player_list:
                while True:
                    x = input("Would you like to Hit or Stand? Enter 'h' or 's' ")

                    if x[0].lower() == 'h':
                        player.store_card(deck.draw_card())
                        player.aces()
                        player.print_hand()

                    elif x[0].lower() == 's':
                        print("Player stands.")
                        player_list -= player
                        if len(player_list) == 0:
                            playing = False

                    else:
                        print("Sorry, please try again.")
                        continue
                    break

            while True:
                if dealer.value <= 16:
                    dealer.store_card(deck.draw_card())
                    dealer.aces()
                elif dealer.value > 21:
                    print('Dealer bust.')                    
                else:
                    print('Dealer stands.')
